#include <stdio.h>
#include <stdlib.h>
#include <conio.h> // ????????? Windows ????????
#include <windows.h> // ????????? Windows ????????
#include <time.h>

// ???????????
#define WIDTH 40
#define HEIGHT 20

// ?????????????????????????????????????
typedef struct {
    int x;
    int y;
} Point;

Point snake_head;
Point food;

int score;
int gameOver;
int dir; // 0=STOP, 1=LEFT, 2=RIGHT, 3=UP, 4=DOWN

// ????????????????????? Cross-platform
void clearScreen() {
    #ifdef _WIN32
        system("cls");
    #else
        system("clear");
    #endif
}

void setup() {
    srand(time(NULL));
    gameOver = 0;
    snake_head.x = WIDTH / 2;
    snake_head.y = HEIGHT / 2;
    food.x = rand() % WIDTH;
    food.y = rand() % HEIGHT;
    score = 0;
    dir = 0;
}

void draw() {
    clearScreen(); // ????????????????????????????????????

    // ????????????
    for (int i = 0; i < WIDTH + 2; i++) printf("#");
    printf("\n");

    // ????????????????????
    for (int i = 0; i < HEIGHT; i++) {
        for (int j = 0; j < WIDTH; j++) {
            if (j == 0) printf("#");

            if (i == snake_head.y && j == snake_head.x)
                printf("O"); // ??
            else if (i == food.y && j == food.x)
                printf("X"); // ?????
            else
                printf(" ");

            if (j == WIDTH - 1) printf("#");
        }
        printf("\n");
    }

    // ??????????????
    for (int i = 0; i < WIDTH + 2; i++) printf("#");
    printf("\n");

    printf("Score: %d\n", score);
}

void input() {
    // ??????? Input ????????????? Windows ????????
    // ??????????????? Linux/macOS ??????????????? getch() ?????????? ncurses
    if (_kbhit()) {
        switch (_getch()) {
            case 'a': dir = 1; break;
            case 'd': dir = 2; break;
            case 'w': dir = 3; break;
            case 's': dir = 4; break;
            case 'x': gameOver = 1; break;
        }
    }
}

void logic() {
    switch (dir) {
        case 1: snake_head.x--; break;
        case 2: snake_head.x++; break;
        case 3: snake_head.y--; break;
        case 4: snake_head.y++; break;
    }

    // ????????
    if (snake_head.x < 0 || snake_head.x >= WIDTH || snake_head.y < 0 || snake_head.y >= HEIGHT)
        gameOver = 1;

    // ???????????
    if (snake_head.x == food.x && snake_head.y == food.y) {
        score += 1;
        food.x = rand() % WIDTH;
        food.y = rand() % HEIGHT;
    }
}

int main() {
    setup();

    while (!gameOver) {
        draw();
        input();
        logic();
        Sleep(100); // ?????????
    }

    printf("Game Over! Final Score: %d\n", score);
    return 0;
}
